version: '3.8'

# Noon-E-Commerce Docker Stack
# Using host network for ClickHouse access (localhost-bound)

services:
  # FastAPI Backend
  noon-api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: noon-api
    network_mode: host
    environment:
      - CLICKHOUSE_HOST=127.0.0.1
      - CLICKHOUSE_PORT=9000
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:?CLICKHOUSE_PASSWORD is required}
      - CLICKHOUSE_DB=noon_intelligence
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      - API_TOKEN=${API_TOKEN:?API_TOKEN is required}
      - API_PORT=8096
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3001}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8096/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    # Security hardening
    read_only: true
    tmpfs:
      - /tmp:size=100M,mode=1777
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

  # React Frontend (TypeScript version)
  noon-frontend:
    build:
      context: ../frontend-ts
      dockerfile: ../docker/Dockerfile.frontend
    container_name: noon-frontend
    ports:
      - "127.0.0.1:3001:80"
    environment:
      - VITE_API_URL=http://localhost:8096
      - VITE_API_TOKEN=${API_TOKEN:-noon-api-secret-token}
    restart: unless-stopped
    # Security hardening
    read_only: true
    tmpfs:
      - /tmp:size=50M,mode=1777
      - /var/cache/nginx:size=50M,mode=1777
      - /var/run:size=10M,mode=1777
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required for nginx to bind to port 80
    security_opt:
      - no-new-privileges:true
